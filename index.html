// Ganti dengan API Key ChatGPT anda
const openAiKey = "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";

// Fungsi Jana AI untuk Rumusan
window.generateFinalAI = async (id) => {
    const s = students.find(x => x.id === id);
    const m = liveMarks[id] || {};
    const p1 = m['Penilai 1'] || {pecut:0, lontar:0};
    const p2 = m['Penilai 2'] || {pecut:0, lontar:0};
    const avgPecut = ((p1.pecut + p2.pecut) / 2).toFixed(2);
    const avgLontar = ((p1.lontar + p2.lontar) / 2).toFixed(2);

    try {
        const response = await fetch("https://api.openai.com/v1/chat/completions", {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": `Bearer ${openAiKey}` },
            body: JSON.stringify({
                model: "gpt-3.5-turbo",
                messages: [{role: "user", content: `Berikan rumusan prestasi sukan profesional (Bahasa Melayu, 30 patah perkataan) untuk atlet ${s.name}. Purata Lari Pecut: ${avgPecut}/25, Purata Lontar Peluru: ${avgLontar}/25.`}]
            })
        });
        const data = await response.json();
        const aiResult = data.choices[0].message.content;
        
        // Simpan ke Sheets (Lajur K, L, M)
        await fetch(scriptURL, { 
            method: 'POST', 
            mode: 'no-cors', 
            body: JSON.stringify({ 
                id: id, 
                finalPecut: avgPecut, 
                finalLontar: avgLontar, 
                aiReport: aiResult 
            }) 
        });
        
        alert("Rumusan AI Berjaya Dijana & Disimpan!");
        fetchMarks(); // Refresh data
    } catch (e) { alert("Ralat Janaan AI"); }
};

// Kemas kini Janaan PDF untuk memasukkan AI
function preparePrintReport() {
    const container = document.getElementById('printReport');
    const filtered = students.filter(s => !selectedClass || s.class === selectedClass);
    
    let reportHtml = filtered.map(s => {
        const m = liveMarks[s.id] || {};
        const p1 = m['Penilai 1'] || {pecut:0, lontar:0};
        const p2 = m['Penilai 2'] || {pecut:0, lontar:0};
        const avgP = ((p1.pecut + p2.pecut) / 2).toFixed(2);
        const avgL = ((p1.lontar + p2.lontar) / 2).toFixed(2);
        const aiComment = m.aiReport || "Rumusan AI belum dijana.";

        return `
            <div class="page-break" style="padding:20px; border:1px solid #000; margin-bottom:20px;">
                <h3>LAPORAN PRESTASI INDIVIDU: ${s.name}</h3>
                <p>Kelas: ${s.class} | ID: ${s.id}</p>
                <table border="1" style="width:100%; border-collapse:collapse; text-align:center;">
                    <tr><th>ACARA</th><th>PENILAI 1</th><th>PENILAI 2</th><th>PURATA AKHIR</th></tr>
                    <tr><td>LARI PECUT</td><td>${p1.pecut}</td><td>${p2.pecut}</td><td><b>${avgP}</b></td></tr>
                    <tr><td>LONTAR PELURU</td><td>${p1.lontar}</td><td>${p2.lontar}</td><td><b>${avgL}</b></td></tr>
                </table>
                <div style="margin-top:15px; padding:10px; background:#f0f0f0; border-left:5px solid #00f2ff;">
                    <b>RUMUSAN PRESTASI (AI):</b><br>
                    <p><i>${aiComment}</i></p>
                </div>
            </div>`;
    }).join('');
    container.innerHTML = reportHtml;
}
