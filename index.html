function saveMarkah() {
  const pelajarId = document.getElementById('pelajar').value;
  if (!pelajarId) return showToast("Pilih pelajar dahulu.", "error");

  const student = allStudents.find(s => s.ID_SISTEM === pelajarId);
  const formData = {
    ID_SISTEM: pelajarId,
    Nama_Pelajar: student.Nama_Pelajar,
    Kelas: student.Kelas
  };

  // Ambil nilai sebagai NOMBOR
  larianItems.forEach(item => {
    const key = `HP3_${item.name.toUpperCase()}_${item.max}`;
    formData[key] = parseFloat(document.getElementById(`slider-${item.name}`).value) || 0;
  });
  lontaranItems.forEach(item => {
    const key = `HP3_${item.name.toUpperCase()}_${item.max}`;
    formData[key] = parseFloat(document.getElementById(`slider-${item.name}`).value) || 0;
  });

  // Gambar
  const previewLarian = document.getElementById('preview-larian');
  const previewLontaran = document.getElementById('preview-lontaran');
  if (previewLarian?.src?.startsWith('data:image')) {
    formData.imageLarian = previewLarian.src;
  }
  if (previewLontaran?.src?.startsWith('data:image')) {
    formData.imageLontaran = previewLontaran.src;
  }

  const sheetName = currentUser.allowed_sheet === 'P1' ? 'MARKAH_HP3_P1' : 'MARKAH_HP3_P2';

  showLoader(true);
  fetch(WEB_APP_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      action: 'save_mark',
      userEmail: currentUser.email,
      role: currentUser.role,
      sheetName,
      formData
    })
  })
  .then(r => r.json())
  .then(data => {
    showToast(data.message || "Berjaya disimpan!", data.result === 'success' ? 'success' : 'error');
    if (data.result === 'success') {
      loadData(); // Muat semula data
    }
    showLoader(false);
  })
  .catch(err => {
    console.error(err);
    showToast("Ralat sambungan.", "error");
    showLoader(false);
  });
}
